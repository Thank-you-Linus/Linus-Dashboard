name: "Code Quality"

on:
  pull_request:
    branches:
      - "main"
    types: [opened, synchronize, reopened]

jobs:
  quality-check:
    name: "Code Quality Check"
    runs-on: "ubuntu-latest"
    steps:
      - name: "Checkout the repository"
        uses: "actions/checkout@v5"

      - name: "Set up Node.js"
        uses: "actions/setup-node@v5"
        with:
          node-version: 24
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Build project"
        run: npm run build

      - name: "Verify build output"
        run: |
          if [ ! -f "custom_components/linus_dashboard/www/linus-strategy.js" ]; then
            echo "âŒ Build output not found"
            exit 1
          fi
          echo "âœ… Build output verified"

      - name: "Run ESLint (non-blocking)"
        continue-on-error: true
        id: eslint
        run: |
          npm run lint:check > eslint-report.txt 2>&1 || true
          if [ $? -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… ESLint passed"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ ESLint found issues"
            cat eslint-report.txt
          fi

      - name: "Run TypeScript Check (non-blocking)"
        continue-on-error: true
        id: typecheck
        run: |
          npm run type-check > typecheck-report.txt 2>&1 || true
          ERROR_COUNT=$(grep -c "error TS" typecheck-report.txt || echo 0)
          if [ $ERROR_COUNT -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… No TypeScript errors"
          else
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "count=$ERROR_COUNT" >> $GITHUB_OUTPUT
            echo "âš ï¸ Found $ERROR_COUNT TypeScript errors"
            head -30 typecheck-report.txt
            if [ $ERROR_COUNT -gt 30 ]; then
              echo "... and more (showing first 30)"
            fi
          fi

      - name: "Run Smoke Tests"
        run: npm run test:smoke

      - name: "Comment PR with results"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const eslintStatus = '${{ steps.eslint.outputs.status }}' || 'unknown';
            const typecheckStatus = '${{ steps.typecheck.outputs.status }}' || 'unknown';
            const errorCount = '${{ steps.typecheck.outputs.count }}' || '0';
            
            const statusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'warning') return 'âš ï¸';
              return 'â“';
            };
            
            const body = `## ğŸ” Code Quality Check Results
            
            | Check | Status | Details |
            |-------|--------|---------|
            | Build | âœ… | Build completed successfully |
            | Smoke Tests | âœ… | All smoke tests passed |
            | ESLint | ${statusEmoji(eslintStatus)} | ${eslintStatus === 'success' ? 'No issues' : 'Has warnings (non-blocking)'} |
            | TypeScript | ${statusEmoji(typecheckStatus)} | ${typecheckStatus === 'success' ? 'No errors' : `${errorCount} type errors (non-blocking)`} |
            
            ${typecheckStatus === 'warning' ? 'âš ï¸ **Note**: TypeScript errors are currently non-blocking but should be addressed in future PRs.' : ''}
            ${eslintStatus === 'warning' ? 'âš ï¸ **Note**: ESLint issues detected. Run \`npm run lint\` to auto-fix.' : ''}
            
            ---
            *This is an automated check. Build and smoke tests must pass.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
