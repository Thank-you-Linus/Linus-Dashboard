name: "Pre-Release"

on:
  push:
    tags:
      - '*-beta.*'
      - '*-alpha.*'

permissions:
  contents: write

jobs:
  prerelease:
    name: "Create Pre-Release"
    runs-on: "ubuntu-latest"
    steps:
      # 0. Validate tag format
      - name: "Validate tag format"
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG_NAME"
          
          # Check if tag matches semantic version with pre-release
          if ! [[ "$TAG_NAME" =~ ^[0-9]+\.[0-9]+\.[0-9]+-(alpha|beta)\.[0-9]+$ ]]; then
            echo "‚ùå Error: Invalid tag format. Expected: X.Y.Z-alpha.N or X.Y.Z-beta.N"
            echo "   Got: $TAG_NAME"
            exit 1
          fi
          
          echo "‚úÖ Tag format is valid"
      # 1. Checkout le code source
      - name: "Checkout the repository"
        uses: "actions/checkout@v5"

      # 2. Configurer Node.js
      - name: "Set up Node.js"
        uses: "actions/setup-node@v5"
        with:
          node-version: 24

      # 3. Installer les d√©pendances
      - name: "Install dependencies"
        run: npm install

      # 4. Generate CHANGELOG.md for HACS
      - name: "Generate CHANGELOG.md"
        run: |
          bash scripts/generate-changelog.sh
          echo "‚úÖ CHANGELOG.md generated"

      # 5. Run linting and type checking (blocking)
      - name: "Lint and type check"
        run: |
          npm run lint:check
          npm run type-check

      # 6. Compiler le code
      - name: "Build the project"
        run: npm run build

      # 7. Verify build output exists
      - name: "Verify build output"
        run: |
          if [ ! -f "${{ github.workspace }}/custom_components/linus_dashboard/www/linus-strategy.js" ]; then
            echo "‚ùå Error: Build output not found"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      # 8. Run smoke tests
      - name: "Run Smoke Tests"
        run: npm run test:smoke

      # 9. Cr√©er l'archive ZIP
      - name: "ZIP the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/linus_dashboard"
          zip linus_dashboard.zip -r ./

      # 10. Extraire le tag et la version
      - name: "Extract version info"
        id: version
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$TAG_NAME" >> $GITHUB_OUTPUT

      # 11. G√©n√©rer et formater les release notes pour GitHub
      - name: "Format release notes for GitHub"
        id: release_notes
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "‚úÖ Found RELEASE_NOTES.md"
            
            # Format the release notes with collapsible sections (modifies RELEASE_NOTES.md in-place)
            bash scripts/format-release-notes.sh
            
            echo "‚úÖ Using formatted RELEASE_NOTES.md"
            NOTES=$(cat RELEASE_NOTES.md)
          else
            echo "‚ö†Ô∏è No RELEASE_NOTES.md found, generating from commits"
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              NOTES="## Changes\n\n$(git log --pretty=format:'- %s' --no-merges -10)"
            else
              NOTES="## Changes\n\n$(git log ${LAST_TAG}..HEAD --pretty=format:'- %s' --no-merges)"
            fi
          fi
          
          # Save to file for upload
          echo "$NOTES" > /tmp/release_notes.md
          
          # Also set as output (escaped for GitHub Actions)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 12. Cr√©er la pre-release sur GitHub
      - name: "Create GitHub Pre-Release"
        id: create_release
        uses: "softprops/action-gh-release@v2"
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "üß™ ${{ steps.version.outputs.version }} (Pre-Release)"
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: true
          files: ${{ github.workspace }}/custom_components/linus_dashboard/linus_dashboard.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 13. Envoyer la notification Discord
      - name: "Send Discord Notification"
        if: success()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            bash scripts/notify-discord.sh prerelease "${{ steps.version.outputs.version }}" "${{ steps.create_release.outputs.url }}" || {
              echo "‚ö†Ô∏è Discord notification failed, but release will continue"
              exit 0
            }
          else
            echo "‚ö†Ô∏è Discord webhook not configured, skipping notification"
          fi

      # 14. Nettoyer le fichier de release notes apr√®s publication
      - name: "Clean up release notes file"
        if: success()
        continue-on-error: true
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git rm RELEASE_NOTES.md || true
            git commit -m "chore: Clean up release notes after pre-release" || true
            git push origin HEAD:main || {
              echo "‚ö†Ô∏è Failed to push cleanup commit, but release succeeded"
              exit 0
            }
          fi

      # 15. Notification d'√©chec (si la release a √©chou√©)
      - name: "Notify on Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "content": "‚ùå **Pre-Release Failed** ‚ùå\n\n**Version:** ${{ steps.version.outputs.version }}\n**Workflow:** ${{ github.workflow }}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPlease check the logs and consider using `scripts/rollback-release.sh ${{ steps.version.outputs.version }}` if needed."
              }' \
              "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord failure notification"
          fi
          echo "‚ö†Ô∏è Release failed. Consider running: scripts/rollback-release.sh ${{ steps.version.outputs.version }}"
