name: "Release"

on:
  release:
    types:
      - "published"
  push:
    tags:
      - "*.*.*"

permissions: {}

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      # 0. Get tag name and validate release
      - name: "Get tag name"
        id: get_tag
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            # Check if tag contains alpha/beta
            if [[ "$TAG_NAME" =~ (alpha|beta) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
            RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "üì¶ Tag: $TAG_NAME"
          echo "üè∑Ô∏è Pre-release: $IS_PRERELEASE"

      - name: "Validate release"
        run: |
          if [[ "${{ steps.get_tag.outputs.is_prerelease }}" == "true" ]]; then
            echo "‚ö†Ô∏è This is a pre-release, skipping stable release workflow"
            exit 0
          fi
          echo "‚úÖ This is a stable release"

      # 1. Checkout le code source
      - name: "Checkout the repository"
        uses: "actions/checkout@v5"

      # 2. Configurer Node.js
      - name: "Set up Node.js"
        uses: "actions/setup-node@v5"
        with:
          node-version: 24 # Ajuste la version si n√©cessaire

      # 3. Installer les d√©pendances
      - name: "Install dependencies"
        run: npm install

      # 4. Generate CHANGELOG.md for HACS
      - name: "Generate CHANGELOG.md"
        run: |
          bash scripts/generate-changelog.sh
          echo "‚úÖ CHANGELOG.md generated"

      # 5. Run linting and type checking (blocking)
      - name: "Lint and type check"
        run: |
          npm run lint:check
          npm run type-check

      # 6. Compiler le code
      - name: "Build the project"
        run: npm run build

      # 7. Verify build output exists
      - name: "Verify build output"
        run: |
          if [ ! -f "${{ github.workspace }}/custom_components/linus_dashboard/www/linus-strategy.js" ]; then
            echo "‚ùå Error: Build output not found"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      # 8. Run smoke tests
      - name: "Run Smoke Tests"
        run: npm run test:smoke

      # 9. Cr√©er l'archive ZIP
      - name: "ZIP the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/linus_dashboard"
          zip linus_dashboard.zip -r ./

      # 9.5. Verify release notes exist
      - name: "Verify release notes"
        run: |
          if [ ! -f "RELEASE_NOTES.md" ]; then
            echo "‚ùå Error: RELEASE_NOTES.md not found!"
            echo "Please create RELEASE_NOTES.md before releasing stable version"
            exit 1
          fi
          echo "‚úÖ RELEASE_NOTES.md found"
          echo "üìÑ Content preview:"
          head -20 RELEASE_NOTES.md

      # 10. Create GitHub Release and upload ZIP
      - name: "Create GitHub Release"
        uses: "softprops/action-gh-release@v2.3.3"
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: "v${{ steps.get_tag.outputs.tag_name }}"
          body_path: RELEASE_NOTES.md
          files: ${{ github.workspace }}/custom_components/linus_dashboard/linus_dashboard.zip
          draft: false
          prerelease: false
          make_latest: true

      # 11. Send Discord notification for stable release
      - name: "Send Discord Notification"
        if: success()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_WEBHOOK_STABLE_URL: ${{ secrets.DISCORD_WEBHOOK_STABLE_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_STABLE_URL" ] || [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TAG_NAME="${{ steps.get_tag.outputs.tag_name }}"
            RELEASE_URL="${{ steps.get_tag.outputs.release_url }}"
            bash scripts/notify-discord.sh release "$TAG_NAME" "$RELEASE_URL" || {
              echo "‚ö†Ô∏è Discord notification failed, but release succeeded"
              exit 0
            }
          else
            echo "‚ö†Ô∏è Discord webhook not configured, skipping notification"
          fi

      # 12. Reminder to post on forums
      - name: "Forum Posting Reminder"
        if: success()
        run: |
          echo "üì¢ Release published successfully!"
          echo "üìù Don't forget to announce on forums:"
          echo "   - Run: npm run forums:open"
          echo "   - Or visit manually:"
          echo "     ‚Ä¢ Home Assistant: https://community.home-assistant.io/"
          echo "     ‚Ä¢ HACF: https://forum.hacf.fr/"

      # 13. Notification d'√©chec (si la release a √©chou√©)
      - name: "Notify on Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "content": "‚ùå **Stable Release Failed** ‚ùå\n\n**Version:** ${{ steps.get_tag.outputs.tag_name }}\n**Workflow:** ${{ github.workflow }}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPlease check the logs and consider using `scripts/rollback-release.sh ${{ steps.get_tag.outputs.tag_name }}` if needed."
              }' \
              "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord failure notification"
          fi
          echo "‚ö†Ô∏è Release failed. Consider running: scripts/rollback-release.sh ${{ steps.get_tag.outputs.tag_name }}"
