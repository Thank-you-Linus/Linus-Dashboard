name: "Release"

on:
  release:
    types:
      - "published"

permissions: {}

jobs:
  release:
    name: "Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      # 0. Validate release (not a pre-release)
      - name: "Validate release"
        run: |
          if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "‚ö†Ô∏è This is a pre-release, skipping stable release workflow"
            exit 0
          fi
          echo "‚úÖ This is a stable release"

      # 1. Checkout le code source
      - name: "Checkout the repository"
        uses: "actions/checkout@v5"

      # 2. Configurer Node.js
      - name: "Set up Node.js"
        uses: "actions/setup-node@v5"
        with:
          node-version: 24 # Ajuste la version si n√©cessaire

      # 3. Installer les d√©pendances
      - name: "Install dependencies"
        run: npm install

      # 4. Generate CHANGELOG.md for HACS
      - name: "Generate CHANGELOG.md"
        run: |
          bash scripts/generate-changelog.sh
          echo "‚úÖ CHANGELOG.md generated"

      # 5. Run linting and type checking (optional, can be disabled if needed)
      - name: "Lint and type check"
        continue-on-error: true
        run: |
          npm run lint:check || echo "‚ö†Ô∏è Linting skipped (needs ESLint v9 migration)"
          npm run type-check || echo "‚ö†Ô∏è Type checking skipped (has errors)"
          echo "‚úÖ Lint and type check step completed (errors ignored)"

      # 6. Compiler le code
      - name: "Build the project"
        run: npm run build

      # 7. Verify build output exists
      - name: "Verify build output"
        run: |
          if [ ! -f "${{ github.workspace }}/custom_components/linus_dashboard/www/linus-strategy.js" ]; then
            echo "‚ùå Error: Build output not found"
            exit 1
          fi
          echo "‚úÖ Build output verified"

      # 8. Run smoke tests
      - name: "Run Smoke Tests"
        run: npm run test:smoke

      # 9. Cr√©er l'archive ZIP
      - name: "ZIP the integration directory"
        shell: "bash"
        run: |
          cd "${{ github.workspace }}/custom_components/linus_dashboard"
          zip linus_dashboard.zip -r ./

      # 10. T√©l√©charger l'archive ZIP dans la release
      - name: "Upload the ZIP file to the release"
        uses: "softprops/action-gh-release@v2.3.3"
        with:
          files: ${{ github.workspace }}/custom_components/linus_dashboard/linus_dashboard.zip

      # 11. Send Discord notification for stable release
      - name: "Send Discord Notification"
        if: success()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            bash scripts/notify-discord.sh release "$TAG_NAME" "$RELEASE_URL" || {
              echo "‚ö†Ô∏è Discord notification failed, but release succeeded"
              exit 0
            }
          else
            echo "‚ö†Ô∏è Discord webhook not configured, skipping notification"
          fi

      # 12. Reminder to post on forums
      - name: "Forum Posting Reminder"
        if: success()
        run: |
          echo "üì¢ Release published successfully!"
          echo "üìù Don't forget to announce on forums:"
          echo "   - Run: npm run forums:open"
          echo "   - Or visit manually:"
          echo "     ‚Ä¢ Home Assistant: https://community.home-assistant.io/"
          echo "     ‚Ä¢ HACF: https://forum.hacf.fr/"

      # 13. Notification d'√©chec (si la release a √©chou√©)
      - name: "Notify on Failure"
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "content": "‚ùå **Stable Release Failed** ‚ùå\n\n**Version:** ${{ github.event.release.tag_name }}\n**Workflow:** ${{ github.workflow }}\n**Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nPlease check the logs and consider using `scripts/rollback-release.sh ${{ github.event.release.tag_name }}` if needed."
              }' \
              "$DISCORD_WEBHOOK_URL" || echo "Failed to send Discord failure notification"
          fi
          echo "‚ö†Ô∏è Release failed. Consider running: scripts/rollback-release.sh ${{ github.event.release.tag_name }}"
